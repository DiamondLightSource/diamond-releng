<?xml version="1.0" encoding="UTF-8"?>
<project name="headless-ant-driver" basedir=".">

	<pathconvert property="workspace.loc" setonempty="false">
		<regexpmapper from="(.*)_git/.+" to="\1"/>
		<path><pathelement location="${ant.file}" /></path>
	</pathconvert>
	<fail message="ERROR: Could not determine workspace.loc" unless="workspace.loc" />
	<property name="workspace.git.loc" value="${workspace.loc}_git" />

	<!-- ====================================================================
	       Management of sub-builds
	     ==================================================================== -->

	<target name="select-projects-for-subant" depends="_plugins-for-subant-specified, _projects-for-subant-specified, _projects-for-subant-all">
	</target>

	<!-- select just those projects matching the user-supplied list with a releng.ant -->
	<!-- note poor original choice of property name "plugin_list" (rather than the more accurate "project_list")
	     we're stuck with it, as this is generated by pewma.py, and it has to support all GDA versions
	-->
	<target name="_plugins-for-subant-specified" if="plugin_list">  <!-- effective if pewma.py generates the old name, plugin_list -->
		<pathconvert property="project-releng-files" pathsep=" " setonempty="false">
			<regexpmapper from="^(.*)(${plugin_list})(/)releng.ant$$" to="\2\3releng.ant" handledirsep="yes"/>
			<fileset dir="${workspace.git.loc}" erroronmissingdir="false">
				<include name="**/releng.ant" />
			</fileset>
		</pathconvert>
	</target>
	<target name="_projects-for-subant-specified" if="project_list">  <!-- effective if pewma.py generates the old name, project_list -->
		<pathconvert property="project-releng-files" pathsep=" " setonempty="false">
			<regexpmapper from="^(.*)(${plugin_list})(/)releng.ant$$" to="\2\3releng.ant" handledirsep="yes"/>
			<fileset dir="${workspace.git.loc}" erroronmissingdir="false">
				<include name="**/releng.ant" />
			</fileset>
		</pathconvert>
	</target>
	<target name="_projects-for-subant-all" unless="project-releng-files">
		<property name="project-releng-files" value="**${file.separator}releng.ant" />
	</target>

	<macrodef name="iterate_projects">
		<attribute name="target" />
		<attribute name="project-releng-files" />
		<attribute name="echo.level" default="debug" />
		<attribute name="inheritAll" default="false" />
		<attribute name="inheritRefs" default="false" />
		<attribute name="verbose" default="false" />
		<!-- subant cannot pass anything back to the parent, so set failonerror true -->
		<!-- a failing test is not an error, only an explicitly issued fail (eg in target jython-call) -->
		<attribute name="failonerror" default="true" />
		<element name="subant-elements" implicit="yes" optional="true" />
		<sequential>
			<echo level="@{echo.level}">iterating over @{target} in @{project-releng-files}</echo>
			<subant target="@{target}" inheritAll="@{inheritAll}" inheritRefs="@{inheritRefs}" verbose="@{verbose}" failonerror="@{failonerror}">
				<fileset dir="${workspace.git.loc}" includes="@{project-releng-files}" erroronmissingdir="false" />
				<property name="archivePrefix" value="${archivePrefix}" />
				<property name="gdaVerboseSetting" value="${gdaVerboseSetting}" />
				<propertyset>
					<propertyref prefix="START_DATETIME" />
				</propertyset>
				<propertyset>
					<propertyref prefix="gda.testing" />
				</propertyset>
				<subant-elements />
			</subant>
		</sequential>
	</macrodef>

	<!-- ====================================================================
	       Utilities
	     ==================================================================== -->

	<target name="print-ant-properties">
		<echo level="warning">List of all Ant Properties</echo>
		<echoproperties />
	</target>

	<target name="dummy" depends="select-projects-for-subant">  <!-- useful for testing the build files themselves -->
		<iterate_projects target="dummy" project-releng-files="${project-releng-files}" echo.level="debug" />
	</target>

	<!-- ====================================================================
	       CORBA Compile
	     ==================================================================== -->

	<target name="corba-clean" description="Delete work folders used when generating CORBA jars" depends="select-projects-for-subant">
		<iterate_projects target="corba-clean" project-releng-files="${project-releng-files}" echo.level="debug" />
	</target>

	<target name="corba-make-jar" description="Builds the jar containing CORBA classes for all or selected projects" depends="select-projects-for-subant">
		<iterate_projects target="corba-make-jar" project-releng-files="${project-releng-files}" />
	</target>

	<target name="corba-validate-jar" description="Validates the jar containing CORBA classes for all or selected projects" depends="select-projects-for-subant">
		<iterate_projects target="corba-validate-jar" project-releng-files="${project-releng-files}" />
	</target>

	<!-- ====================================================================
	       Testing
	     ==================================================================== -->

	<target name="tests-clean" description="Delete test output and results files from JUnit/JyUnit tests" depends="select-projects-for-subant">
		<iterate_projects target="tests-clean" project-releng-files="${project-releng-files}" />
	</target>

	<target name="junit-tests" depends="select-projects-for-subant" description="Run Java JUnit tests for all (or selected) projects">
		<iterate_projects target="junit-tests" project-releng-files="${project-releng-files}" echo.level="debug" />
	</target>

	<target name="jyunit-tests" depends="select-projects-for-subant" description="Runs JyUnit tests for all (or selected) projects">
		<iterate_projects target="jyunit-tests" project-releng-files="${project-releng-files}" echo.level="debug" />
	</target>

	<target name="all-tests" depends="select-projects-for-subant" description="Runs both Java and JyUnit tests for all (or selected) projects">
		<iterate_projects target="all-tests" project-releng-files="${project-releng-files}" />
	</target>

</project>
